---
title: "New_cff"
author: "Kevin Healy"
date: "17/11/2020"
output: html_document
---



```{r packages, tidy = TRUE, results = "hide"}

library(phytools)
library(caper)
library(MCMCglmm)
library(hdrcde)
library(mulTree)
source("MultiDisPlot.R")
```


Read in the data

```{r setup, include=FALSE}

cff_raw <- read.csv("final_cff_data_27_july_2021.csv", 
                    header = T,
                    sep = ",")

colnames(cff_raw)[1] <- "Scientific_name"

#cff_raw[cff_raw$mode_of_life == "scavenger",]$mode_of_life <- "pred_forage"
#cff_raw[cff_raw$mode_of_life == "herbivore",]$mode_of_life <- "pred_forage"
#cff_raw[cff_raw$Habitat == "marine_reef",]$Habitat <- "demersal"
cff_raw[cff_raw$Habitat == "benthopelagic",]$Habitat <- "pelagic"
#cff_raw[cff_raw$Habitat == "bathypelagic",]$Habitat <- "pelagic"
cff_raw[cff_raw$Habitat == "arboreal",]$Habitat <- "terrestrial"

cff_raw$mode_of_life <- factor(cff_raw$mode_of_life, 
                                  levels = c("pred_forage",   
                                             "deposite", 
                                             "pred_ballistic",   
                                             "pred_pursuit"
                                             ))
#As there is only 1 deposite species we will drop it
cff_raw <- cff_raw[cff_raw$mode_of_life != "deposite",]

cff_raw$Habitat <- factor(cff_raw$Habitat, 
                                  levels = c("terrestrial",
                                             #"arboreal",
                                             "pelagic", 
                                             "demersal",
                                             "volant"
                                             ))
  
 
cff_clean <- cff_raw[,c("Scientific_name",
                        "taxa_group",
                        "taxa_phyla",
                        "taxa_class",
                        "Light_Level",
                        "Method",
                        "Max_CFF_Hz",
                        "Bodymass.g.",
                        "Habitat",
                        "mode_of_life")]
 

cff_clean <- data.frame(cff_clean, animal = cff_clean$Scientific_name)

cff_clean <- na.omit(cff_clean)

```


Read in the phylogeny.

```{r phylo, include=FALSE}

cff_tree <- read.tree("cff_tree_27_july_2021.tree")

cff_tree <- cff_tree[1:100]

```

We can plot the phylogeny


```{r phylo plot, include=FALSE}

#create data with rownames for p
rownames(cff_clean) <- cff_clean$Scientific_name
Max_CFF_Hz_plot <-setNames(cff_clean$Max_CFF_Hz,rownames(cff_clean))


par(mar=c(5.1,4.1,4.1,2.1))

plotTree.wBars(cff_tree[[1]], 
                 Max_CFF_Hz_plot,
     type = "fan",
     scale = 0.5,
     tip.labels = F, cex = 0.2)


plot(cff_tree[[1]],
          type = "fan",
          cex = 0.5)

```



#MulTree
Set the data into a Multree object.

```{r Multree data, include=FALSE}

cff_mul <- as.mulTree(cff_clean, 
                      cff_tree, 
                      taxa = "animal", 
                      rand.terms = ~animal,
                      clean.data = FALSE)


```



##Set the parameters
Here we set the number of iterations, the thinning and the burn-in

```{r parameters}

nitt <- 2400000
thin <- 1000
burnin <- 400000

parameters <- c(nitt,
                thin,
                burnin)

```


##Set the prior

Set the prior. Here we stick with a x prior.

```{r prior}
prior <-list(R = list(V = 1, nu=0.002), 
             G = list(G1=list(V = 1,n = 2, 
                              nu=0.002)
                     ))


```



```{r glm, include=FALSE}


mulTree(mulTree.data = cff_mul, 
        formula = Max_CFF_Hz ~ log10(Bodymass.g.)*Light_Level 
                                  + mode_of_life
                                  + Habitat 
        , parameters = parameters, 
        chains = 2,
        priors = prior,
        convergence = 1.1, 
        ESS = 1000, 
        verbose = TRUE,
        output = "mulTree_models", 
        warn = FALSE, 
        ask = TRUE)


#full_model_1 <- MCMCglmm(Max_CFF_Hz ~ log10(Bodymass.g.)*Light_Level 
#                                  + mode_of_life
#                                  + Habitat         
#                         ,
#                         random = ~ animal,
#                         rcov=~ units, 
#                         data = cff_clean, 
#                         pedigree = cff_tree[[1]], 
#                         prior = prior,
#                         family=c("gaussian"), 
#                         nitt = nitt, thin = thin, burnin = burnin,
#                         verbose= FALSE)

#summary(full_model_1)

```

#Read in the multiple runs


```{r glm, include=FALSE}

Main_models <-   read.mulTree(mulTree.chain = "mulTree_models", 
                              convergence = FALSE, 
                              model = FALSE,
                              extract = NULL)


inter_main_p <-  hdr(Main_models$`(Intercept)`)
mass_log10_main_p <-  hdr(Main_models$`log10(Bodymass.g.)`)
lit_low_main_p <-  hdr(Main_models$Light_Levellow)
#deposite_main_p <-  hdr(Main_models$mode_of_lifedeposite)
ballistic_main_p <-  hdr(Main_models$mode_of_lifepred_ballistic)
#scav_main_p <-  hdr(Main_models$mode_of_lifescavenger)
pur_main_p <-  hdr(Main_models$mode_of_lifepred_pursuit)
#herb_main_p <-  hdr(Main_models$mode_of_lifeherbivore)
pel_main_p <-  hdr(Main_models$Habitatpelagic)
dem_main_p <-  hdr(Main_models$Habitatdemersal)
#reef_main_p <-  hdr(Main_models$Habitatmarine_reef)
#bath_main_p <-  hdr(Main_models$Habitatbathypelagic)
vol_main_p <-  hdr(Main_models$Habitatvolant)
#arb_main_p <-  hdr(Main_models$Habitatarboreal)
#bentpelagic_main_p <-  hdr(Main_models$Habitatbenthopelagic)
body_lit_inter_main_p <-  hdr(Main_models$`log10(Bodymass.g.):Light_Levellow`)

phylo_main_p <-  hdr(Main_models$phylogenetic.variance)

H_main <- Main_models$phylogenetic.variance/c(Main_models$phylogenetic.variance + Main_models$residual.variance)
  
unit_main_p <-  hdr(Main_models$residual.variance)


```



plot total
```{r glm, include=FALSE}

plot(cff_raw$Max_CFF_Hz ~ log10(cff_raw$Bodymass.g.),
     
     col = "white",
     pch = 16,
     bty = "n",
     ylab = "CFF (Hz)",
     xlab = "log10 of Mass (g)")

points(cff_raw[cff_raw$Light_Level == "low", "Max_CFF_Hz"] ~ log10(cff_raw[cff_raw$Light_Level == "low", "Bodymass.g."]),
       col = "grey70",
       pch= 16)

points(cff_raw[cff_raw$Light_Level == "high", "Max_CFF_Hz"] ~ log10(cff_raw[cff_raw$Light_Level == "high", "Bodymass.g."]),
       col = rgb(247/250,224/250,89/250),
       pch= 16)


points(cff_raw[cff_raw$Habitat== "volant", "Max_CFF_Hz"] ~ log10(cff_raw[cff_raw$Habitat== "volant", "Bodymass.g."]),
       col = "white",
       pch= 16, cex = 0.5)



##high light
abline(inter_main_p$mode, mass_log10_main_p$mode,
       col = rgb(247/250,224/250,89/250),
       lty = 4,
       lwd = 3)

##low light
abline(inter_main_p$mode + lit_low_main_p$mode, 
       mass_log10_main_p$mode + body_lit_inter_main_p$mode,
       col = "grey70",
       lty = 4,
       lwd = 3)



```







##terrestrial

#MulTree
Set the data into a Multree object.

```{r Multree data, include=FALSE}


cff_t <- cff_clean[cff_clean$Habitat %in% c("volant", 
                                        "terrestrial"
                                        #,"arboreal"
                                        ),]

cff_t$Habitat <- factor(cff_t$Habitat, 
                                  levels = c("terrestrial",   
                                             "volant"
                                              #,"arboreal"
                                             ))

cff_mul_terr <- as.mulTree(cff_t, 
                      cff_tree, 
                      taxa = "animal", 
                      rand.terms = ~animal,
                      clean.data = FALSE)


```



Run the terrestrial multree model

```{r multre terr, include=FALSE}


mulTree(mulTree.data = cff_mul_terr, 
        formula = Max_CFF_Hz ~ log10(Bodymass.g.)*Light_Level 
                                  + mode_of_life
                                  + Habitat,
        parameters = parameters, 
        chains = 2,
        priors = prior,
        convergence = 1.1, 
        ESS = 1000, 
        verbose = TRUE,
        output = "cff_terr_models", 
        warn = FALSE, 
        ask = TRUE)


#full_ter_1 <- MCMCglmm(Max_CFF_Hz ~ log10(Bodymass.g.)*Light_Level 
#                                  + mode_of_life
#                                  + Habitat,
#                         random = ~ animal,
#                         rcov=~ units, 
#                         data = cff_t, 
#                         pedigree = cff_tree[[1]], 
#                         prior = prior,
#                         family=c("gaussian"), 
#                        nitt = nitt, thin = thin, burnin = burnin,
#                         verbose= FALSE)
#summary(full_ter_1)

```

Read in the multiple terrestrial models 

```{r glm, include=FALSE}

ter_models <-   read.mulTree(mulTree.chain = "cff_terr_models", 
                              convergence = FALSE, 
                              model = FALSE,
                              extract = NULL)


inter_ter_p <-  hdr(ter_models$`(Intercept)`)
mass_log10_ter_p <-  hdr(ter_models$`log10(Bodymass.g.)`)
lit_low_ter_p <-  hdr(ter_models$Light_Levellow)
ballistic_ter_p <-  hdr(ter_models$mode_of_lifepred_ballistic)
#scav_ter_p <-  hdr(ter_models$mode_of_lifescavenger)
pur_ter_p <-  hdr(ter_models$mode_of_lifepred_pursuit)
#herb_ter_p <-  hdr(ter_models$mode_of_lifeherbivore)
vol_ter_p <-  hdr(ter_models$Habitatvolant)
#arb_ter_p <-  hdr(ter_models$Habitatarboreal)
body_lit_inter_ter_p <-  hdr(ter_models$`log10(Bodymass.g.):Light_Levellow`)

phylo_ter_p <-  hdr(ter_models$phylogenetic.variance)

H_ter <- ter_models$phylogenetic.variance/c(ter_models$phylogenetic.variance + ter_models$residual.variance)
  
unit_ter_p <-  hdr(ter_models$residual.variance)


```


plot main terrestrial
```{r glm, include=FALSE}


plot(cff_t[, "Max_CFF_Hz"] ~ log10(cff_t[, "Bodymass.g."]),
       col = "white",
       pch= 16,
     bty = "n",
     ylab = "CFF (Hz)",
     xlab = "log10 of Mass (g)")

points(cff_t[cff_t$Light_Level == "low", "Max_CFF_Hz"] ~ log10(cff_t[cff_t$Light_Level == "low", "Bodymass.g."]),
       col = "grey70",
       pch= 16)


points(cff_t[cff_t$Light_Level == "high", "Max_CFF_Hz"] ~ log10(cff_t[cff_t$Light_Level == "high", "Bodymass.g."]),
       col = rgb(247/250,224/250,89/250),
       pch= 16)

#put hollows in volant
points(cff_t[cff_t$Habitat == "volant", "Max_CFF_Hz"] ~ log10(cff_t[cff_t$Habitat == "volant", "Bodymass.g."]),
       col = "white",
       cex = 0.5,
       pch= 16)

##high light
abline(inter_ter_p$mode, mass_log10_ter_p$mode,
       col = rgb(247/250,224/250,89/250),
       lty = 4,
       lwd = 3)

##low light
abline(inter_ter_p$mode + lit_low_ter_p$mode, 
       mass_log10_ter_p$mode + body_lit_inter_ter_p$mode,
       col = "grey70",
       lty = 4,
       lwd = 3)


```


Plot volant versus non volant

```{r volatn jitter, include=FALSE}

plot(cff_t[, "Max_CFF_Hz"] ~ jitter(as.numeric(cff_t[, "Habitat"])),
       col = "white",
       pch= 16,
     bty = "n",
     xlim = c(0.5,2.5))

points(cff_t[cff_t$Light_Level == "low", "Max_CFF_Hz"] ~ jitter(as.numeric(cff_t[cff_t$Light_Level == "low", "Habitat"]), 0.5),
       col = "grey70",
       pch= 16)

points(cff_t[cff_t$Light_Level == "high", "Max_CFF_Hz"] ~ jitter(as.numeric(cff_t[cff_t$Light_Level == "high", "Habitat"]), 0.5),
       col = rgb(247/250,224/250,89/250),
       pch= 16)

```


##Marine analysis


```{r marine data, include=FALSE}

cff_m <- cff_clean[cff_clean$Habitat %in% c("pelagic", 
                                        "demersal"
                                        #"marine_reef",
                                        #"benthopelagic"
                                        #,"bathypelagic"
                                        ),]

cff_m$Habitat <- factor(cff_m$Habitat, 
                                  levels = c("demersal",
                                             "pelagic" 
                                        #"marine_reef",
                                        #"benthopelagic",
                                         #"bathypelagic"
                                        ))


cff_mul_mar <- as.mulTree(cff_m, 
                      cff_tree, 
                      taxa = "animal", 
                      rand.terms = ~animal,
                      clean.data = FALSE)


```




```{r marine model, include=FALSE}


mulTree(mulTree.data = cff_mul_mar, 
        formula = Max_CFF_Hz ~ log10(Bodymass.g.)*Light_Level 
                                  + mode_of_life
                                  + Habitat,
        parameters = parameters, 
        chains = 2,
        priors = prior,
        convergence = 1.1, 
        ESS = 1000, 
        verbose = TRUE,
        output = "cff_mar_models", 
        warn = FALSE, 
        ask = TRUE)


#full_mar_1 <- MCMCglmm(Max_CFF_Hz ~ log10(Bodymass.g.)*Light_Level 
#                                  + mode_of_life
#                                  + Habitat
#                       ,
#                         random = ~ animal,
#                         rcov=~ units, 
#                         data = cff_m, 
#                         pedigree = cff_tree[[1]], 
#                         prior = prior,
#                         family=c("gaussian"), 
#                         nitt = nitt, thin = thin, burnin = burnin,
#                         verbose= FALSE)
#summary(full_mar_1)

```



Read in the multiple marine models 

```{r marine read, include=FALSE}

mar_models <-   read.mulTree(mulTree.chain = "cff_mar_models", 
                              convergence = FALSE, 
                              model = FALSE,
                              extract = NULL)


inter_mar_p <-  hdr(mar_models$`(Intercept)`)
mass_log10_mar_p <-  hdr(mar_models$`log10(Bodymass.g.)`)
lit_low_mar_p <-  hdr(mar_models$Light_Levellow)
ballistic_mar_p <-  hdr(mar_models$mode_of_lifepred_ballistic)
#scav_mar_p <-  hdr(mar_models$mode_of_lifescavenger)
pur_mar_p <-  hdr(mar_models$mode_of_lifepred_pursuit)
body_lit_inter_mar_p <-  hdr(mar_models$`log10(Bodymass.g.):Light_Levellow`)

phylo_mar_p <-  hdr(mar_models$phylogenetic.variance)

H_mar <- mar_models$phylogenetic.variance/c(mar_models$phylogenetic.variance + mar_models$residual.variance)
  
unit_mar_p <-  hdr(mar_models$residual.variance)


```







plot marine
```{r glm, include=FALSE}



plot(cff_m[, "Max_CFF_Hz"] ~ log10(cff_m[, "Bodymass.g."]),
       col = "white",            
        cex = 1.3,
       pch= 16,
     bty = "n")


points(cff_m[cff_m$Light_Level == "high", "Max_CFF_Hz"] ~ log10(cff_m[cff_m$Light_Level == "high", "Bodymass.g."]),
       col = rgb(247/250,224/250,89/250),
       pch= 16)

points(cff_m[cff_m$Light_Level == "low", "Max_CFF_Hz"] ~ log10(cff_m[cff_m$Light_Level == "low", "Bodymass.g."]),
       col = "grey70",
       pch= 16)


points(cff_m[cff_m$mode_of_life == "pred_ballistic", "Max_CFF_Hz"] ~ log10(cff_m[cff_m$mode_of_life == "pred_ballistic", "Bodymass.g."]),
       col = "white",
       cex = 0.7,
       pch= 16)




points(cff_m[cff_m$mode_of_life == "pred_pursuit" & cff_m$Light_Level == "high", "Max_CFF_Hz"] ~ log10(cff_m[cff_m$mode_of_life == "pred_pursuit" & cff_m$Light_Level == "high", "Bodymass.g."]),
       col = "white",
       cex = 1.3,
       pch= 16)

points(cff_m[cff_m$mode_of_life == "pred_pursuit" & cff_m$Light_Level == "low", "Max_CFF_Hz"] ~ log10(cff_m[cff_m$mode_of_life == "pred_pursuit" & cff_m$Light_Level == "low", "Bodymass.g."]),
       col = "white",
       cex = 1.3,
       pch= 17)




points(cff_m[cff_m$mode_of_life == "pred_pursuit" & cff_m$Light_Level == "high", "Max_CFF_Hz"] ~ log10(cff_m[cff_m$mode_of_life == "pred_pursuit" & cff_m$Light_Level == "high", "Bodymass.g."]),
       col = rgb(247/250,224/250,89/250),
       cex = 1,
       pch= 17)

points(cff_m[cff_m$mode_of_life == "pred_pursuit" & cff_m$Light_Level == "low", "Max_CFF_Hz"] ~ log10(cff_m[cff_m$mode_of_life == "pred_pursuit" & cff_m$Light_Level == "low", "Bodymass.g."]),
       col = "grey70",
       cex = 1,
       pch= 17)



##high light
abline(summary(full_mar_1)$solutions[1], summary(full_mar_1)$solutions[2],
       col = rgb(247/250,224/250,89/250),
       lty = 4,
       lwd = 3)

##low light
abline(summary(full_mar_1)$solutions[1] + summary(full_mar_1)$solutions[3], 
       summary(full_mar_1)$solutions[2] + summary(full_mar_1)$solutions[8],
       col = "grey70",
       lty = 4,
       lwd = 3)


```




Plot ballistic versus non volant

```{r volatn jitter, include=FALSE}

plot(cff_m[, "Max_CFF_Hz"] ~ jitter(as.numeric(cff_m[, "mode_of_life"])),
       col = "white",
       pch= 16,
     bty = "n",
     xlim = c(0.5,4.5))



#plot(cff_m[, "Max_CFF_Hz"] ~ cff_m[, "mode_of_life"],
#       col = "white",
#       pch= 16,
#     bty = "n",
#     xlim = c(0.5,4.5))




points(cff_m[cff_m$Light_Level == "low", "Max_CFF_Hz"] ~ jitter(as.numeric(cff_m[cff_m$Light_Level == "low", "mode_of_life"]), 0.5),
       col = "grey70",
       pch= 16)

points(cff_m[cff_m$Light_Level == "high", "Max_CFF_Hz"] ~ jitter(as.numeric(cff_m[cff_m$Light_Level == "high", "mode_of_life"]), 0.5),
       col = rgb(247/250,224/250,89/250),
       pch= 16)



points(median(cff_m[cff_m$mode_of_life == "pred_forage", "Max_CFF_Hz"]) ~ c(1), pch = 3 )

points(median(cff_m[cff_m$mode_of_life == "pred_ballistic", "Max_CFF_Hz"]) ~ c(3), pch = 3 )

points(median(cff_m[cff_m$mode_of_life == "pred_pursuit", "Max_CFF_Hz"]) ~ c(4), pch = 3 )




```






#plot phylo
We can also plot the phylogeny

```{r phylo plot}

#First make a named vector of the mean trait value.

plot_CFF <- vector()

for(i in 1:length(cff_clean$Scientific_name)){
  
  plot_CFF[i] <-  cff_clean[ cff_clean$Scientific_name ==  sort(cff_clean$Scientific_name)[i] , "Max_CFF_Hz"]

}

names(plot_CFF) <- sort(cff_tree[[1]]$tip.label)


#pdf("phylobar_ld50.pdf")
plotTree.wBars(tree = cff_tree[[1]], 
               x = plot_CFF, 
               scale= 1, 
               type="fan", 
               cex = 0.2, 
               tip.labels = T, 
               fsize=0.37, 
               width = 1)
#dev.off()

```
